# PostgreSQL Configuration for Sentient AGI Reasoning Server
# Optimized for cognitive workloads with 16GB RAM target environment
# Supports TimescaleDB for time-series cognitive analytics

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

max_connections = 100                   # Moderate connection limit for memory efficiency
shared_preload_libraries = 'timescaledb,pg_stat_statements'

#------------------------------------------------------------------------------
# RESOURCE USAGE (based on 16GB system)
#------------------------------------------------------------------------------

# Memory Configuration (Conservative for 16GB system)
shared_buffers = 4GB                    # 25% of RAM for shared memory
effective_cache_size = 12GB             # 75% of RAM estimate for OS cache
work_mem = 256MB                        # Memory for sorts/joins per operation
maintenance_work_mem = 1GB              # Memory for maintenance operations
autovacuum_work_mem = 512MB             # Memory for autovacuum operations

# Background Writer
bgwriter_delay = 200ms                  # Background writer sleep time
bgwriter_lru_maxpages = 100             # LRU pages written per round
bgwriter_lru_multiplier = 2.0           # Multiple of average buffer usage

#------------------------------------------------------------------------------
# WRITE AHEAD LOG (WAL)
#------------------------------------------------------------------------------

# WAL Configuration for cognitive workloads
wal_level = replica                     # Enable replication
wal_buffers = 64MB                      # WAL buffer size
wal_writer_delay = 200ms                # WAL writer delay
checkpoint_timeout = 10min              # Checkpoint interval
checkpoint_completion_target = 0.9      # Spread checkpoints over time
max_wal_size = 2GB                      # Maximum WAL size
min_wal_size = 1GB                      # Minimum WAL size

# Archive settings (disabled by default)
archive_mode = off                      # Change to 'on' for production
# archive_command = ''                  # Archive command for backups

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Planner Configuration
random_page_cost = 1.5                  # Optimized for SSD storage
effective_io_concurrency = 200          # Concurrent I/O operations for SSD
default_statistics_target = 500         # Statistics collection target

# Query Execution
jit = on                               # Enable Just-In-Time compilation
jit_above_cost = 500000                # JIT threshold
jit_optimize_above_cost = 500000       # JIT optimization threshold

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------

# Query Logging for Performance Analysis
logging_collector = on                  # Enable log collection
log_destination = 'stderr'              # Log to stderr
log_directory = 'log'                   # Log directory
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600                    # Log file permissions
log_rotation_age = 1d                   # Rotate logs daily
log_rotation_size = 100MB               # Rotate at 100MB

# Log Content Configuration
log_min_duration_statement = 1000       # Log slow queries (>1s)
log_checkpoints = on                    # Log checkpoints
log_connections = on                    # Log connections
log_disconnections = on                 # Log disconnections
log_lock_waits = on                     # Log lock waits
log_statement = 'mod'                   # Log modification statements
log_temp_files = 0                      # Log all temp files

# Log Formatting
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_statement_stats = off               # Don't log statement stats
log_parser_stats = off                  # Don't log parser stats
log_planner_stats = off                 # Don't log planner stats
log_executor_stats = off                # Don't log executor stats

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------

# Autovacuum Configuration for Cognitive Workloads
autovacuum = on                         # Enable autovacuum
autovacuum_max_workers = 4              # Maximum autovacuum workers
autovacuum_naptime = 30s                # Autovacuum sleep time
autovacuum_vacuum_threshold = 50        # Minimum updates before vacuum
autovacuum_analyze_threshold = 50       # Minimum updates before analyze
autovacuum_vacuum_scale_factor = 0.1    # Fraction of table size for vacuum
autovacuum_analyze_scale_factor = 0.05  # Fraction of table size for analyze
autovacuum_vacuum_cost_delay = 10ms     # Autovacuum cost delay
autovacuum_vacuum_cost_limit = 2000     # Autovacuum cost limit

#------------------------------------------------------------------------------
# COGNITIVE WORKLOAD OPTIMIZATIONS
#------------------------------------------------------------------------------

# JSONB and Full-Text Search Optimizations
gin_fuzzy_search_limit = 0              # No limit on GIN fuzzy search
gin_pending_list_limit = 16MB           # GIN pending list size

# Statement Timeout and Lock Timeout
statement_timeout = 300000              # 5 minute statement timeout
lock_timeout = 60000                    # 1 minute lock timeout
idle_in_transaction_session_timeout = 300000  # 5 minute idle transaction timeout

# Parallel Query Configuration
max_parallel_workers_per_gather = 4     # Parallel workers per query
max_parallel_workers = 8                # Maximum parallel workers
max_parallel_maintenance_workers = 4    # Parallel maintenance workers

#------------------------------------------------------------------------------
# EXTENSION-SPECIFIC SETTINGS
#------------------------------------------------------------------------------

# TimescaleDB Configuration
timescaledb.max_background_workers = 8  # Background workers for TimescaleDB

# pg_stat_statements Configuration
pg_stat_statements.max = 10000          # Maximum statements tracked
pg_stat_statements.track = all          # Track all statements
pg_stat_statements.track_utility = off  # Don't track utility statements
pg_stat_statements.save = on            # Save statistics across restarts

#------------------------------------------------------------------------------
# SECURITY
#------------------------------------------------------------------------------

# Password Encryption
password_encryption = scram-sha-256     # Use SCRAM-SHA-256

#------------------------------------------------------------------------------
# MONITORING
#------------------------------------------------------------------------------

# Statistics Collection
track_activities = on                   # Track activities
track_counts = on                      # Track counts
track_io_timing = on                   # Track I/O timing
track_functions = all                  # Track function calls
stats_temp_directory = 'pg_stat_tmp'   # Temporary statistics directory

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Locale and Formatting
datestyle = 'iso, mdy'                 # Date style
timezone = 'UTC'                       # Use UTC for consistency
lc_messages = 'en_US.UTF-8'           # Error message language
lc_monetary = 'en_US.UTF-8'           # Monetary formatting
lc_numeric = 'en_US.UTF-8'            # Numeric formatting
lc_time = 'en_US.UTF-8'               # Time formatting

# Default Connection Settings
default_text_search_config = 'pg_catalog.english'  # Default text search

#------------------------------------------------------------------------------
# DEVELOPMENT AND DEBUGGING
#------------------------------------------------------------------------------

# Development Settings (disable in production)
log_statement = 'none'                 # Don't log all statements in production
log_min_messages = warning             # Minimum log level
client_min_messages = notice           # Client minimum log level

# Debug Configuration (disable in production)
debug_print_parse = off                # Don't print parse tree
debug_print_rewritten = off           # Don't print rewritten queries
debug_print_plan = off                 # Don't print execution plans
debug_pretty_print = on                # Pretty print debug output

#------------------------------------------------------------------------------
# COGNITIVE WORKLOAD SPECIFIC SETTINGS
#------------------------------------------------------------------------------

# These settings are optimized for the cognitive reasoning workload:
# - High JSONB usage for flexible metadata storage
# - Complex analytical queries with time-series data
# - Mixed read/write workload with burst patterns

# Increase limits for complex cognitive queries
max_stack_depth = 4MB                  # Stack depth for complex queries
temp_file_limit = 2GB                  # Temporary file size limit per session

# Optimize for analytical workloads
enable_hashjoin = on                   # Enable hash joins
enable_mergejoin = on                  # Enable merge joins
enable_nestloop = on                   # Enable nested loop joins
enable_seqscan = on                    # Enable sequential scans
enable_indexscan = on                  # Enable index scans
enable_bitmapscan = on                 # Enable bitmap scans

# Memory-intensive operation settings
hash_mem_multiplier = 2.0              # Hash table memory multiplier
logical_decoding_work_mem = 64MB       # Logical decoding memory

#------------------------------------------------------------------------------
# PERFORMANCE MONITORING SETTINGS
#------------------------------------------------------------------------------

# Query Performance Insights
compute_query_id = on                  # Enable query ID computation
log_min_duration_statement = 1000      # Log queries taking > 1 second

# Connection and Session Monitoring
log_connections = on                   # Log new connections
log_disconnections = on                # Log disconnections
log_duration = off                     # Don't log all query durations

# This configuration is optimized for:
# 1. Cognitive workloads with complex JSONB queries
# 2. Time-series data analysis with TimescaleDB
# 3. Memory efficiency on 16GB systems
# 4. Development and production monitoring